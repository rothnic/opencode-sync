# minimal opencode agent setup
name: OpenCode Agent
on: workflow_dispatch

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  agent:
    runs-on: ubuntu-latest
    environment: copilot  # Required for secret access
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1

      # Install opencode and restore auth in one step
      - name: Restore OpenCode Identity
        uses: ./  # Uses the action in the repo root
        with:
          bundle: ${{ secrets.OPENCODE_AUTH_BUNDLE }}
      
      - name: Inspect Environment (Debug)
        run: |
          echo "‚úÖ OpenCode Identity Restored"
          echo "üìÇ Config Location: ~/.config/opencode/opencode.jsonc"
          if [ -f ~/.config/opencode/opencode.jsonc ]; then
            grep -C 2 "model" ~/.config/opencode/opencode.jsonc || echo "Model not found in config"
          else
            echo "‚ùå Config file missing"
          fi

      # Now opencode is ready to use!
      - name: Run OpenCode Issue Manager
        timeout-minutes: 30
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: opencode run --command "manage-issues"
